{% extends "enrollment_base.html" %}

{% block title %}Attendance Records - Programming Course{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/@tailwindplus/elements@1" type="module"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8" x-data="attendanceApp()" x-init="init()">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Attendance Records</h1>
                    <p class="text-gray-600">View your attendance history and track your progress</p>
                </div>
                <a href="{{ url_for('participant_portal.dashboard') }}"
                   class="inline-flex items-center text-blue-600 hover:text-blue-500 font-medium">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L4.414 9H17a1 1 0 110 2H4.414l5.293 5.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" x-show="loading" class="flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600">Loading attendance data...</span>
        </div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="attendanceContent" x-show="!loading">

            <!-- Top Section: Calendar and Issues Side by Side -->
            <div class="md:grid md:grid-cols-2 md:divide-x md:divide-gray-200 bg-white rounded-lg shadow-md mb-8">

                <!-- Calendar Section -->
                <div class="md:pr-6 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-medium text-gray-900">Attendance Calendar</h2>
                        <div class="flex items-center space-x-2">
                            <button id="prevMonth" @click="navigateMonth(-1)" type="button"
                                    class="p-2 text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-md">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <h3 id="currentMonth" class="text-sm font-medium text-gray-900" x-text="currentMonthName"></h3>
                            <button id="nextMonth" @click="navigateMonth(1)" type="button"
                                    class="p-2 text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-md">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 text-center text-sm">
                        <!-- Day Headers -->
                        <div class="p-2 text-xs font-medium text-gray-500">Mon</div>
                        <div class="p-2 text-xs font-medium text-gray-500">Tue</div>
                        <div class="p-2 text-xs font-medium text-gray-500">Wed</div>
                        <div class="p-2 text-xs font-medium text-gray-500">Thu</div>
                        <div class="p-2 text-xs font-medium text-gray-500">Fri</div>
                        <div class="p-2 text-xs font-medium text-gray-500">Sat</div>
                        <div class="p-2 text-xs font-medium text-gray-500">Sun</div>

                        <!-- Calendar Days -->
                        <template x-for="day in calendarDays" :key="day.key">
                            <div class="relative p-1">
                                <button :class="day.classes"
                                        class="w-8 h-8 text-xs rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        :disabled="!day.isCurrentMonth">
                                    <time :datetime="day.datetime" x-text="day.day"></time>
                                    <div x-show="day.hasAttendance" class="absolute bottom-0 right-0 w-2 h-2 rounded-full" :class="day.indicatorClass"></div>
                                </button>
                            </div>
                        </template>
                    </div>

                    <!-- Calendar Stats -->
                    <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                        <div class="bg-green-50 p-3 rounded-lg">
                            <div id="attendanceRate" class="text-lg font-semibold text-green-600" x-text="(attendanceStats.attendance_rate || 0) + '%'">-</div>
                            <div class="text-xs text-gray-600">Attendance Rate</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <div id="correctSessionRate" class="text-lg font-semibold text-blue-600" x-text="(attendanceStats.correct_session_rate || 0) + '%'">-</div>
                            <div class="text-xs text-gray-600">Correct Sessions</div>
                        </div>
                    </div>
                </div>

                <!-- Issues Section -->
                <div class="md:pl-6 p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Attendance Issues</h2>

                    <!-- Issues List -->
                    <div id="issuesList" x-show="attendanceIssues.length > 0" class="space-y-3">
                        <template x-for="issue in attendanceIssues" :key="issue.type">
                            <div class="flex items-start space-x-3 p-3 rounded-lg"
                                 :class="issue.severity === 'danger' ? 'bg-red-50 border border-red-200' : 'bg-yellow-50 border border-yellow-200'">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5"
                                         :class="issue.severity === 'danger' ? 'text-red-400' : 'text-yellow-400'"
                                         fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium"
                                       :class="issue.severity === 'danger' ? 'text-red-800' : 'text-yellow-800'"
                                       x-text="issue.title || issue.message"></p>
                                    <p x-show="issue.title" class="text-sm"
                                       :class="issue.severity === 'danger' ? 'text-red-700' : 'text-yellow-700'"
                                       x-text="issue.message"></p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- No Issues -->
                    <div id="noIssues" x-show="attendanceIssues.length === 0"
                         class="text-center py-6">
                        <svg class="mx-auto h-12 w-12 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <p class="mt-2 text-sm text-gray-500">No attendance issues</p>
                        <p class="text-xs text-gray-400">Keep up the good work!</p>
                    </div>
                </div>
            </div>

            <!-- Attendance Records Section -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">Attendance Records</h2>
                </div>

                <!-- Tab Navigation -->
                <div class="border-b border-gray-200">
                    <!-- Desktop Tabs -->
                    <nav class="hidden sm:flex -mb-px">
                        <button @click="switchTab('all')" :class="currentTab === 'all' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="tab-button w-1/4 py-2 px-1 text-center border-b-2 font-medium text-sm">
                            All Records
                            <span class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs" x-text="recordCounts.all || 0"></span>
                        </button>
                        <button @click="switchTab('saturday')" :class="currentTab === 'saturday' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="tab-button w-1/4 py-2 px-1 text-center border-b-2 font-medium text-sm">
                            Saturday
                            <span class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs" x-text="recordCounts.saturday || 0"></span>
                        </button>
                        <button @click="switchTab('sunday')" :class="currentTab === 'sunday' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="tab-button w-1/4 py-2 px-1 text-center border-b-2 font-medium text-sm">
                            Sunday
                            <span class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs" x-text="recordCounts.sunday || 0"></span>
                        </button>
                    </nav>

                    <!-- Mobile Tab Select -->
                    <div class="sm:hidden">
                        <select id="mobileTabSelect" @change="switchTab($event.target.value)" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Records</option>
                            <option value="saturday">Saturday</option>
                            <option value="sunday">Sunday</option>
                        </select>
                    </div>
                </div>

                <!-- Records Loading State -->
                <div id="recordsLoading" x-show="recordsLoading" class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span class="ml-2 text-gray-600">Loading records...</span>
                </div>

                <!-- Records Table -->
                <div id="recordsTable" x-show="!recordsLoading && filteredRecords.length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session Type</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                            <template x-for="record in filteredRecords" :key="record.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.date"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.time"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.session.day"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.session.time_slot"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="record.status === 'present' ? 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800' : 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800'"
                                              x-text="record.status === 'present' ? 'Present' : 'Absent'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="record.is_correct_session ? 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800' : 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800'"
                                              x-text="record.is_correct_session ? 'Correct' : 'Wrong Session'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- No Records -->
                <div id="noRecords" x-show="!recordsLoading && filteredRecords.length === 0"
                     class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-500">No attendance records found</p>
                    <p class="text-xs text-gray-400">Attendance records will appear here once you start attending sessions.</p>
                </div>

                <!-- Pagination -->
                <div id="pagination" x-show="pagination.pages > 1" class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobile" @click="navigatePage(-1)" :disabled="pagination.page <= 1"
                                class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                            Previous
                        </button>
                        <button id="nextPageMobile" @click="navigatePage(1)" :disabled="pagination.page >= pagination.pages"
                                class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                            Next
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Showing <span id="recordsStart" x-text="((pagination.page - 1) * pagination.limit) + 1"></span>
                                to <span id="recordsEnd" x-text="Math.min(pagination.page * pagination.limit, pagination.total)"></span>
                                of <span id="recordsTotal" x-text="pagination.total"></span> results
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button id="prevPage" @click="navigatePage(-1)" :disabled="pagination.page <= 1"
                                        class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <span id="pageInfo" class="px-3 py-2 text-sm text-gray-700" x-text="`Page ${pagination.page} of ${pagination.pages}`">Page 1 of 5</span>
                                <button id="nextPage" @click="navigatePage(1)" :disabled="pagination.page >= pagination.pages"
                                        class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Attendance Alpine.js component
function attendanceApp() {
    return {
        // State management
        loading: true,
        currentDate: new Date(),
        currentTab: 'all',
        currentPage: 1,
        attendanceData: {},
        calendarData: {},
        attendanceStats: {},
        attendanceIssues: [],
        allRecords: [],
        recordsLoading: false,
        recordCounts: { all: 0, saturday: 0, sunday: 0 },
        pagination: { page: 1, pages: 1, total: 0, limit: 20 },

        // Initialize
        async init() {
            await this.loadAttendanceData();
            this.updateCalendarHeader();
        },

        // Computed properties
        get currentMonthName() {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
        },

        get calendarDays() {
            const year = this.currentDate.getFullYear();
            const month = this.currentDate.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = (firstDay.getDay() + 6) % 7; // Convert to Monday = 0

            const days = [];

            // Add empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                days.push({
                    key: `empty-${i}`,
                    day: '',
                    isCurrentMonth: false,
                    classes: '',
                    datetime: '',
                    hasAttendance: false,
                    indicatorClass: ''
                });
            }

            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = this.calendarData.calendar_data?.[dateStr];
                const isToday = this.isDateToday(year, month, day);

                let classes = 'hover:bg-gray-100';
                let hasAttendance = false;
                let indicatorClass = '';

                if (isToday) {
                    classes += ' bg-blue-600 text-white hover:bg-blue-700';
                } else {
                    classes += ' text-gray-900';
                }

                if (dayData && dayData.length > 0) {
                    hasAttendance = true;
                    const hasPresent = dayData.some(d => d.status === 'present');
                    const hasAbsent = dayData.some(d => d.status === 'absent');
                    const hasCorrect = dayData.some(d => d.is_correct_session);

                    if (hasPresent && hasCorrect) {
                        indicatorClass = 'bg-green-500';
                    } else if (hasPresent) {
                        indicatorClass = 'bg-yellow-500';
                    } else if (hasAbsent) {
                        indicatorClass = 'bg-red-500';
                    }
                }

                days.push({
                    key: `day-${day}`,
                    day: day,
                    isCurrentMonth: true,
                    classes: classes,
                    datetime: dateStr,
                    hasAttendance: hasAttendance,
                    indicatorClass: indicatorClass
                });
            }

            return days;
        },

        get filteredRecords() {
            if (this.currentTab === 'all') {
                return this.allRecords;
            }
            return this.allRecords.filter(record =>
                record.session.day.toLowerCase() === this.currentTab
            );
        },

        // Load all attendance data
        async loadAttendanceData() {
            try {
                // Load summary, issues, and calendar data in parallel
                const [summaryResponse, issuesResponse, calendarResponse] = await Promise.all([
                    this.fetchWithCSRF('/portal/api/attendance/summary'),
                    this.fetchWithCSRF('/portal/api/attendance/issues'),
                    this.fetchWithCSRF(`/portal/api/attendance/calendar-data?month=${this.currentDate.getMonth() + 1}&year=${this.currentDate.getFullYear()}`)
                ]);

                const [summary, issues, calendar] = await Promise.all([
                    summaryResponse.json(),
                    issuesResponse.json(),
                    calendarResponse.json()
                ]);

                // Update display
                if (summary.success) {
                    this.attendanceStats = summary.statistics || {};
                }

                if (issues.success) {
                    this.attendanceIssues = issues.issues || [];
                }

                if (calendar.success) {
                    this.calendarData = calendar;
                }

                // Load attendance records
                await this.loadAttendanceRecords();

            } catch (error) {
                console.error('Failed to load attendance data:', error);
                this.showAlert('error', 'Failed to load attendance data');
            } finally {
                this.loading = false;
            }
        },

        // Calendar functions
        navigateMonth(direction) {
            this.currentDate.setMonth(this.currentDate.getMonth() + direction);
            this.updateCalendarHeader();
            this.loadCalendarData();
        },

        updateCalendarHeader() {
            // This triggers reactivity for currentMonthName
            this.$nextTick();
        },

        async loadCalendarData() {
            try {
                const response = await this.fetchWithCSRF(
                    `/portal/api/attendance/calendar-data?month=${this.currentDate.getMonth() + 1}&year=${this.currentDate.getFullYear()}`
                );
                const data = await response.json();

                if (data.success) {
                    this.calendarData = data;
                }
            } catch (error) {
                console.error('Failed to load calendar data:', error);
            }
        },

        isDateToday(year, month, day) {
            const today = new Date();
            return year === today.getFullYear() &&
                   month === today.getMonth() &&
                   day === today.getDate();
        },

        // Tab management
        switchTab(tab) {
            this.currentTab = tab;
            this.currentPage = 1;

            // Update mobile select
            document.getElementById('mobileTabSelect').value = tab;
        },

        // Load attendance records
        async loadAttendanceRecords() {
            this.recordsLoading = true;

            try {
                let url = `/portal/api/attendance/history?page=${this.currentPage}&limit=20`;

                const response = await this.fetchWithCSRF(url);
                const data = await response.json();

                if (data.success) {
                    this.allRecords = data.records || [];
                    this.pagination = data.pagination || { page: 1, pages: 1, total: 0, limit: 20 };

                    // Update record counts
                    this.recordCounts.all = this.allRecords.length;
                    this.recordCounts.saturday = this.allRecords.filter(r => r.session.day.toLowerCase() === 'saturday').length;
                    this.recordCounts.sunday = this.allRecords.filter(r => r.session.day.toLowerCase() === 'sunday').length;
                } else {
                    this.showAlert('error', 'Failed to load attendance records');
                }
            } catch (error) {
                console.error('Failed to load records:', error);
                this.showAlert('error', 'Failed to load attendance records');
            } finally {
                this.recordsLoading = false;
            }
        },

        navigatePage(direction) {
            this.currentPage += direction;
            this.loadAttendanceRecords();
        },

        // Base template integration
        async fetchWithCSRF(url, options = {}) {
            // Use the base template's method
            const body = document.querySelector('body');
            if (body && body._x_dataStack && body._x_dataStack[0] && body._x_dataStack[0].fetchWithCSRF) {
                return body._x_dataStack[0].fetchWithCSRF(url, options);
            }

            // Fallback implementation
            const csrfToken = this.getCSRFToken();
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken && { 'X-CSRFToken': csrfToken })
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            const response = await fetch(url, mergedOptions);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response;
        },

        getCSRFToken() {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            return metaTag ? metaTag.getAttribute('content') : null;
        },

        showAlert(type, message) {
            // Use the base template's alert system
            const body = document.querySelector('body');
            if (body && body._x_dataStack && body._x_dataStack[0] && body._x_dataStack[0].showAlert) {
                return body._x_dataStack[0].showAlert(type, message);
            }
            // Fallback
            alert(`${type.toUpperCase()}: ${message}`);
        }
    }
}
</script>
{% endblock %}
