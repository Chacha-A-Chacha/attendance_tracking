{% extends "enrollment_base.html" %}

{% block title %}Dashboard - Programming Course{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/@tailwindplus/elements@1" type="module"></script>
{% endblock %}

{% block content %}
<!-- Dashboard Content (using base container properly) -->
<div x-data="dashboardApp()" x-init="init()">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Student Dashboard</h1>
        <p class="text-gray-600">Manage your profile, view attendance, and request session changes</p>

        <!-- Student Representative Actions -->
        {% if is_student_rep %}
        <div class="mt-4 flex gap-3">
            <a href="{{ url_for('participant_portal.students') }}"
               class="inline-flex items-center px-3 py-2 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                </svg>
                View Students
            </a>
            <button @click="openCheckInAssist()"
                    class="inline-flex items-center px-3 py-2 border border-green-300 text-sm font-medium rounded-md text-green-700 bg-green-50 hover:bg-green-100">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                Check-In Assist
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <span class="ml-2 text-gray-600">Loading dashboard...</span>
    </div>

    <!-- Main Content -->
    <div x-show="!loading">

        <!-- Top Section: Profile Photo and QR Code Side by Side -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

            <!-- Profile Photo Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Profile Photo</h2>

                <!-- Photo Display -->
                <div class="flex flex-col items-center">
                    <div class="relative">
                        <!-- Profile Photo (when exists) -->
                        <div x-show="dashboardData.participant?.profile_photo_url" class="w-32 h-32 rounded-full overflow-hidden bg-gray-100 mb-4">
                            <img :src="dashboardData.participant?.profile_photo_url"
                                 alt="Profile Photo"
                                 class="w-full h-full object-cover">
                        </div>

                        <!-- Empty State -->
                        <div x-show="!dashboardData.participant?.profile_photo_url" class="w-32 h-32 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                            <svg class="w-12 h-12 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Photo Actions -->
                    <div class="flex space-x-3">
                        <button @click="$refs.photoUpload.click()"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <span x-show="!dashboardData.participant?.profile_photo_url">Upload Photo</span>
                            <span x-show="dashboardData.participant?.profile_photo_url">Change Photo</span>
                        </button>
                        <button x-show="dashboardData.participant?.profile_photo_url"
                                @click="deleteProfilePhoto()"
                                class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                            Remove Photo
                        </button>
                    </div>

                    <!-- Hidden File Input -->
                    <input type="file"
                           x-ref="photoUpload"
                           @change="handlePhotoUpload($event)"
                           accept="image/jpeg,image/jpg,image/png,image/webp"
                           class="hidden">
                </div>
            </div>

            <!-- QR Code Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Attendance QR Code</h2>

                <!-- QR Code Display -->
                <div class="flex flex-col items-center">
                    <div class="relative">
                        <!-- QR Code (when exists) -->
                        <div x-show="qrCodeData.qr_url" class="w-32 h-32 mb-4">
                            <img :src="qrCodeData.qr_url"
                                 alt="QR Code"
                                 class="w-full h-full object-contain">
                        </div>

                        <!-- Empty State -->
                        <div x-show="!qrCodeData.qr_url" class="w-32 h-32 bg-gray-100 flex items-center justify-center mb-4 rounded-lg">
                            <svg class="w-12 h-12 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 13a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1v-3zM13 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1V4zM9 4a1 1 0 000 2v9a1 1 0 102 0V6a1 1 0 100-2H9z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- QR Code Actions -->
                    <div class="flex flex-col space-y-2 w-full">
                        <button x-show="!qrCodeData.qr_url"
                                @click="generateQRCode()"
                                :disabled="qrCodeLoading"
                                class="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white text-sm font-medium py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <span x-show="!qrCodeLoading">Generate QR Code</span>
                            <span x-show="qrCodeLoading">Generating...</span>
                        </button>

                        <template x-if="qrCodeData.qr_url">
                            <div class="flex space-x-2">
                                <button @click="regenerateQRCode()"
                                        :disabled="qrCodeLoading"
                                        class="flex-1 bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50 text-white text-sm font-medium py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2">
                                    <span x-show="!qrCodeLoading">Regenerate</span>
                                    <span x-show="qrCodeLoading">Processing...</span>
                                </button>
                                <button @click="downloadQRCode()"
                                        class="flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                    Download
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Information Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Profile Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Student ID</label>
                        <p class="text-gray-900" x-text="dashboardData.participant?.unique_id || '-'"></p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <p class="text-gray-900" x-text="dashboardData.participant?.full_name || '-'"></p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <p class="text-gray-900" x-text="dashboardData.participant?.email || '-'"></p>
                    </div>
                </div>
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Classroom</label>
                        <p class="text-gray-900" x-text="dashboardData.participant?.classroom || '-'"></p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Saturday Session</label>
                        <div class="flex items-center justify-between">
                            <p class="text-gray-900" x-text="dashboardData.sessions?.saturday?.time_slot || 'Not assigned'"></p>
                            <button @click="openReassignmentModal('Saturday')"
                                    class="text-blue-600 hover:text-blue-500 text-sm font-medium">
                                Change
                            </button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sunday Session</label>
                        <div class="flex items-center justify-between">
                            <p class="text-gray-900" x-text="dashboardData.sessions?.sunday?.time_slot || 'Not assigned'"></p>
                            <button @click="openReassignmentModal('Sunday')"
                                    class="text-blue-600 hover:text-blue-500 text-sm font-medium">
                                Change
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Attendance Records Link -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <a href="{{ url_for('participant_portal.attendance') }}"
                   class="text-sm text-blue-600 hover:text-blue-500 font-medium">
                    View Attendance Records â†’
                </a>
            </div>
        </div>

        <!-- Quick Stats Section -->
        <div x-show="dashboardData.attendance" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Quick Stats</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" x-text="(dashboardData.attendance?.statistics?.attendance_rate || 0) + '%'">-</div>
                    <div class="text-sm text-gray-600">Attendance Rate</div>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" x-text="dashboardData.attendance?.statistics?.total_sessions_attended || 0">-</div>
                    <div class="text-sm text-gray-600">Total Sessions</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-600" x-text="dashboardData.participant?.consecutive_missed_sessions || 0">-</div>
                    <div class="text-sm text-gray-600">Consecutive Missed</div>
                </div>
            </div>
        </div>

        <!-- Warnings Section -->
        <template x-if="dashboardData.warnings && dashboardData.warnings.length > 0">
            <div class="mt-6 space-y-3">
                <template x-for="warning in dashboardData.warnings" :key="warning.type">
                    <div class="flex items-start space-x-3 p-4 rounded-lg"
                         :class="warning.severity === 'danger' ? 'bg-red-50 border border-red-200' : 'bg-yellow-50 border border-yellow-200'">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5"
                                 :class="warning.severity === 'danger' ? 'text-red-400' : 'text-yellow-400'"
                                 fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium"
                               :class="warning.severity === 'danger' ? 'text-red-800' : 'text-yellow-800'"
                               x-text="warning.message"></p>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </div>
    <!-- Session Reassignment Modal -->
    <el-dialog>
        <dialog x-ref="reassignmentModal" aria-labelledby="reassignment-title" class="fixed inset-0 size-auto max-h-none max-w-none overflow-y-auto bg-transparent backdrop:bg-transparent">
            <el-dialog-backdrop class="fixed inset-0 bg-gray-500/75 transition-opacity data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in"></el-dialog-backdrop>
            <div tabindex="0" class="flex min-h-full items-end justify-center p-4 text-center focus:outline-none sm:items-center sm:p-0">
                <el-dialog-panel class="relative transform overflow-hidden rounded-lg bg-white px-4 pt-5 pb-4 text-left shadow-xl transition-all data-closed:translate-y-4 data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                    <div>
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100">
                            <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-5">
                            <h3 class="text-base font-semibold leading-6 text-gray-900" id="reassignment-title">
                                Request Session Change
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    Request to change your <span x-text="reassignmentData.dayType"></span> session assignment.
                                </p>
                            </div>
                        </div>
                    </div>

                    <form @submit.prevent="submitReassignmentRequest()" class="mt-5 sm:mt-6">
                        <div class="space-y-4">
                            <div>
                                <label for="current-session" class="block text-sm font-medium text-gray-700">Current Session</label>
                                <p class="mt-1 text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-md" x-text="reassignmentData.currentSession"></p>
                            </div>

                            <div>
                                <label for="requested-session" class="block text-sm font-medium text-gray-700">Requested Session</label>
                                <div class="mt-1">
                                    <select id="requested-session" x-model="reassignmentData.requestedSessionId" required
                                            class="block w-full rounded-md bg-white px-3 py-1.5 text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
                                        <option value="">Select a session...</option>
                                        <template x-for="session in availableSessions" :key="session.id">
                                            <option :value="session.id"
                                                    :disabled="!session.has_capacity"
                                                    x-text="`${session.time_slot} (${session.capacity.available} spots available)`"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label for="reassignment-reason" class="block text-sm font-medium text-gray-700">Reason for Change</label>
                                <div class="mt-1">
                                    <textarea id="reassignment-reason" x-model="reassignmentData.reason" rows="3" required
                                              class="block w-full rounded-md bg-white px-3 py-1.5 text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                                              placeholder="Please explain why you need to change your session..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                            <button type="submit"
                                    :disabled="reassignmentSubmitting"
                                    class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 disabled:opacity-50 sm:col-start-2">
                                <span x-show="!reassignmentSubmitting">Submit Request</span>
                                <span x-show="reassignmentSubmitting" class="flex items-center">
                                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Submitting...
                                </span>
                            </button>
                            <button type="button"
                                    @click="$refs.reassignmentModal.close()"
                                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">
                                Cancel
                            </button>
                        </div>
                    </form>
                </el-dialog-panel>
            </div>
        </dialog>
    </el-dialog>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard Alpine.js component that integrates with base template
function dashboardApp() {
    return {
        // State
        loading: true,
        dashboardData: {},
        qrCodeData: {},
        qrCodeLoading: false,
        reassignmentData: {
            dayType: '',
            currentSession: '',
            requestedSessionId: '',
            reason: ''
        },
        availableSessions: [],
        reassignmentSubmitting: false,

        // Initialize dashboard
        async init() {
            await this.loadDashboardData();
            await this.loadQRCodeStatus();
        },

        // Load dashboard data
        async loadDashboardData() {
            try {
                const response = await this.fetchWithCSRF('/portal/api/dashboard/data');
                const data = await response.json();

                if (data.success) {
                    this.dashboardData = data;
                } else {
                    this.showAlert('error', 'Error loading dashboard: ' + data.message);
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
                this.showAlert('error', 'Failed to load dashboard data');
            } finally {
                this.loading = false;
            }
        },

        // Profile photo functions
        async handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await this.fetchWithCSRF('/portal/api/profile/photo/upload', {
                    method: 'POST',
                    body: formData,
                    headers: {} // Remove Content-Type for FormData
                });

                const data = await response.json();

                if (data.success) {
                    this.showAlert('success', 'Profile photo uploaded successfully');
                    this.dashboardData.participant.profile_photo_url = data.photo_url;
                } else {
                    this.showAlert('error', 'Upload failed: ' + data.message);
                }
            } catch (error) {
                console.error('Photo upload error:', error);
                this.showAlert('error', 'Failed to upload photo');
            }

            // Clear file input
            event.target.value = '';
        },

        async deleteProfilePhoto() {
            if (!confirm('Are you sure you want to remove your profile photo?')) return;

            try {
                const response = await this.fetchWithCSRF('/portal/api/profile/photo', {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    this.showAlert('success', 'Profile photo removed');
                    this.dashboardData.participant.profile_photo_url = null;
                } else {
                    this.showAlert('error', 'Failed to remove photo: ' + data.message);
                }
            } catch (error) {
                console.error('Photo delete error:', error);
                this.showAlert('error', 'Failed to remove photo');
            }
        },

        // QR Code functions
        async loadQRCodeStatus() {
            try {
                const response = await this.fetchWithCSRF('/portal/api/qr-code/info');
                const data = await response.json();

                if (data.success) {
                    this.qrCodeData = data;
                }
            } catch (error) {
                console.error('QR status error:', error);
            }
        },

        async generateQRCode() {
            this.qrCodeLoading = true;

            try {
                const response = await this.fetchWithCSRF('/portal/api/qr-code/generate', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    this.showAlert('success', 'QR code generated successfully');
                    this.qrCodeData = data;
                } else {
                    this.showAlert('error', 'Failed to generate QR code: ' + data.message);
                }
            } catch (error) {
                console.error('QR generation error:', error);
                this.showAlert('error', 'Failed to generate QR code');
            } finally {
                this.qrCodeLoading = false;
            }
        },

        async regenerateQRCode() {
            if (!confirm('Are you sure you want to regenerate your QR code? The old one will no longer work.')) return;

            this.qrCodeLoading = true;

            try {
                const response = await this.fetchWithCSRF('/portal/api/qr-code/regenerate', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    this.showAlert('success', 'QR code regenerated successfully');
                    this.qrCodeData = data;
                } else {
                    this.showAlert('error', 'Failed to regenerate QR code: ' + data.message);
                }
            } catch (error) {
                console.error('QR regeneration error:', error);
                this.showAlert('error', 'Failed to regenerate QR code');
            } finally {
                this.qrCodeLoading = false;
            }
        },

        downloadQRCode() {
            window.open('/portal/api/qr-code/download', '_blank');
        },

        // Session reassignment functions
        async openReassignmentModal(dayType) {
            this.reassignmentData.dayType = dayType;
            this.reassignmentData.currentSession = dayType === 'Saturday'
                ? this.dashboardData.sessions?.saturday?.time_slot || 'Not assigned'
                : this.dashboardData.sessions?.sunday?.time_slot || 'Not assigned';

            // Reset form
            this.reassignmentData.requestedSessionId = '';
            this.reassignmentData.reason = '';

            // Load available sessions
            await this.loadAvailableSessions(dayType);

            // Open modal
            this.$refs.reassignmentModal.showModal();
        },

        async loadAvailableSessions(dayType) {
            try {
                const response = await this.fetchWithCSRF(`/portal/api/sessions/available/${dayType}`);
                const data = await response.json();

                if (data.success) {
                    this.availableSessions = data.available_sessions || [];
                } else {
                    this.showAlert('error', 'Failed to load available sessions');
                    this.availableSessions = [];
                }
            } catch (error) {
                console.error('Load sessions error:', error);
                this.showAlert('error', 'Failed to load available sessions');
                this.availableSessions = [];
            }
        },

        async submitReassignmentRequest() {
            this.reassignmentSubmitting = true;

            const formData = {
                day_type: this.reassignmentData.dayType,
                requested_session_id: this.reassignmentData.requestedSessionId,
                reason: this.reassignmentData.reason
            };

            try {
                const response = await this.fetchWithCSRF('/portal/api/reassignment/request', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    this.showAlert('success', 'Reassignment request submitted successfully');
                    this.$refs.reassignmentModal.close();
                    // Reset form
                    this.reassignmentData.requestedSessionId = '';
                    this.reassignmentData.reason = '';
                } else {
                    this.showAlert('error', 'Request failed: ' + data.message);
                }
            } catch (error) {
                console.error('Reassignment request error:', error);
                this.showAlert('error', 'Failed to submit request');
            } finally {
                this.reassignmentSubmitting = false;
            }
        },

        // Student representative functions
        async openCheckInAssist() {
            try {
                const response = await this.fetchWithCSRF('/portal/api/representative/check-in-url');
                const data = await response.json();

                if (data.success) {
                    window.open(data.check_in_url, '_blank');
                } else {
                    this.showAlert('error', 'Failed to get check-in URL');
                }
            } catch (error) {
                console.error('Check-in assist error:', error);
                this.showAlert('error', 'Failed to open check-in assist');
            }
        },

        // Base template integration methods
        getCSRFToken() {
            // Use the base template's method
            const baseApp = Alpine.store('baseApp') || window.baseApp;
            if (baseApp && baseApp.getCSRFToken) {
                return baseApp.getCSRFToken();
            }

            // Fallback
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            return metaTag ? metaTag.getAttribute('content') : null;
        },

        async fetchWithCSRF(url, options = {}) {
            // Use the base template's method if available
            const body = document.querySelector('body');
            if (body && body._x_dataStack && body._x_dataStack[0] && body._x_dataStack[0].fetchWithCSRF) {
                return body._x_dataStack[0].fetchWithCSRF(url, options);
            }

            // Fallback implementation
            const csrfToken = this.getCSRFToken();

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken && { 'X-CSRFToken': csrfToken })
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            try {
                const response = await fetch(url, mergedOptions);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return response;
            } catch (error) {
                console.error('AJAX request failed:', error);
                this.showAlert('error', 'Network error. Please try again.');
                throw error;
            }
        },

        showAlert(type, message) {
            // Use the base template's alert system
            const body = document.querySelector('body');
            if (body && body._x_dataStack && body._x_dataStack[0] && body._x_dataStack[0].showAlert) {
                return body._x_dataStack[0].showAlert(type, message);
            }

            // Fallback to simple alert
            alert(`${type.toUpperCase()}: ${message}`);
        }
    }
}
</script>
{% endblock %}