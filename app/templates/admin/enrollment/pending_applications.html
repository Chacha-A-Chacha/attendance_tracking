{% extends "admin_base.html" %}

{% block title %}Pending Applications - Admin Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8" x-data="pendingApplications()">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Enrollment Applications</h1>
            <p class="text-gray-600">Manage student enrollment applications and approvals</p>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Applications</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.total_applications }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Pending Review</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.pending_applications }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Ready to Enroll</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.ready_for_processing }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Enrolled</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.enrolled_count }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Search -->
                <div class="flex-1">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <input type="text"
                               x-model="search"
                               @input.debounce.300ms="performSearch"
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Search by name, email, phone, or application number...">
                    </div>
                </div>

                <!-- Laptop Filter -->
                <div class="md:w-48">
                    <select x-model="laptopFilter"
                            @change="applyFilters"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Laptop Status</option>
                        <option value="yes">Has Laptop</option>
                        <option value="no">No Laptop</option>
                    </select>
                </div>

                <!-- Results Per Page -->
                <div class="md:w-32">
                    <select x-model="perPage"
                            @change="applyFilters"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="10">10 per page</option>
                        <option value="20" selected>20 per page</option>
                        <option value="50">50 per page</option>
                    </select>
                </div>
            </div>

            <!-- Active Filters Display -->
            <div x-show="hasActiveFilters()" class="mt-4 flex flex-wrap gap-2">
                <span class="text-sm text-gray-600">Active filters:</span>
                <span x-show="search"
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    Search: <span x-text="search"></span>
                    <button @click="clearSearch" class="ml-1.5 text-blue-600 hover:text-blue-500">√ó</button>
                </span>
                <span x-show="laptopFilter"
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    Laptop: <span x-text="laptopFilter === 'yes' ? 'Has Laptop' : 'No Laptop'"></span>
                    <button @click="clearLaptopFilter" class="ml-1.5 text-blue-600 hover:text-blue-500">√ó</button>
                </span>
            </div>
        </div>

        <!-- Applications List -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Loading State -->
            <div x-show="loading" class="p-8 text-center">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Loading applications...</p>
            </div>

            <!-- Applications Grid -->
            <div x-show="!loading" class="divide-y divide-gray-200">
                {% if enrollments %}
                    {% for enrollment in enrollments %}
                    <div class="p-6 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <!-- Application Info -->
                            <div class="flex-1">
                                <div class="flex items-center space-x-4">
                                    <!-- Avatar -->
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="text-blue-600 font-semibold text-lg">
                                            {{ enrollment.first_name[0] }}{{ enrollment.surname[0] }}
                                        </span>
                                    </div>

                                    <!-- Details -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-lg font-semibold text-gray-900">
                                                {{ enrollment.full_name }}
                                            </h3>

                                            <!-- Status Badges -->
                                            <div class="flex items-center space-x-2">
                                                <!-- Enrollment Status -->
                                                {% if enrollment.enrollment_status.value == 'pending' %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                    Pending
                                                </span>
                                                {% elif enrollment.enrollment_status.value == 'payment_pending' %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    Payment Pending
                                                </span>
                                                {% elif enrollment.enrollment_status.value == 'payment_verified' %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    Ready to Enroll
                                                </span>
                                                {% elif enrollment.enrollment_status.value == 'enrolled' %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    Enrolled
                                                </span>
                                                {% elif enrollment.enrollment_status.value == 'rejected' %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                    Rejected
                                                </span>
                                                {% endif %}

                                                <!-- Email Verified -->
                                                {% if enrollment.email_verified %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    ‚úì Email
                                                </span>
                                                {% else %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                    ‚úó Email
                                                </span>
                                                {% endif %}

                                                <!-- Payment Status -->
                                                {% if enrollment.payment_status.value == 'verified' %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    ‚úì Payment
                                                </span>
                                                {% elif enrollment.payment_status.value == 'paid' %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                    ‚è≥ Payment
                                                </span>
                                                {% else %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                    ‚úó Payment
                                                </span>
                                                {% endif %}

                                                <!-- Laptop Status -->
                                                {% if enrollment.has_laptop %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    üíª Has Laptop
                                                </span>
                                                {% else %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                    üì± No Laptop
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="mt-1 flex items-center text-sm text-gray-500 space-x-4">
                                            <span>{{ enrollment.application_number }}</span>
                                            <span>‚Ä¢</span>
                                            <span>{{ enrollment.email }}</span>
                                            <span>‚Ä¢</span>
                                            <span>{{ enrollment.submitted_at.strftime('%b %d, %Y') if enrollment.submitted_at else 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Button -->
                            <div class="ml-6">
                                <a href="{{ url_for('admin.application_detail', enrollment_id=enrollment.id) }}"
                                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="p-12 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3 class="mt-2 text-lg font-medium text-gray-900">No applications found</h3>
                        <p class="mt-1 text-gray-500">Try adjusting your search criteria or filters.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Pagination -->
            {% if total > per_page %}
            <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <!-- Mobile pagination -->
                        {% if has_prev %}
                        <a href="?page={{ prev_num }}&search={{ search }}&laptop={{ laptop_filter }}&per_page={{ per_page }}"
                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Previous
                        </a>
                        {% endif %}

                        {% if has_next %}
                        <a href="?page={{ next_num }}&search={{ search }}&laptop={{ laptop_filter }}&per_page={{ per_page }}"
                           class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Next
                        </a>
                        {% endif %}
                    </div>

                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Showing <span class="font-medium">{{ ((page - 1) * per_page) + 1 }}</span> to
                                <span class="font-medium">{{ ((page - 1) * per_page) + enrollments|length }}</span> of
                                <span class="font-medium">{{ total }}</span> results
                            </p>
                        </div>

                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                <!-- Previous Page -->
                                {% if has_prev %}
                                <a href="?page={{ prev_num }}&search={{ search }}&laptop={{ laptop_filter }}&per_page={{ per_page }}"
                                   class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </a>
                                {% endif %}

                                <!-- Page Numbers -->
                                {% set start_page = [page - 2, 1]|max %}
                                {% set end_page = [page + 2, (total + per_page - 1) // per_page]|min %}

                                {% for p in range(start_page, end_page + 1) %}
                                    {% if p == page %}
                                    <span class="relative inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 text-sm font-medium text-blue-600">
                                        {{ p }}
                                    </span>
                                    {% else %}
                                    <a href="?page={{ p }}&search={{ search }}&laptop={{ laptop_filter }}&per_page={{ per_page }}"
                                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                        {{ p }}
                                    </a>
                                    {% endif %}
                                {% endfor %}

                                <!-- Next Page -->
                                {% if has_next %}
                                <a href="?page={{ next_num }}&search={{ search }}&laptop={{ laptop_filter }}&per_page={{ per_page }}"
                                   class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </a>
                                {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function pendingApplications() {
    return {
        search: '{{ search }}',
        laptopFilter: '{{ laptop_filter }}',
        perPage: '{{ per_page }}',
        loading: false,

        init() {
            // Initialize any needed setup
        },

        hasActiveFilters() {
            return this.search.length > 0 || this.laptopFilter.length > 0;
        },

        clearSearch() {
            this.search = '';
            this.applyFilters();
        },

        clearLaptopFilter() {
            this.laptopFilter = '';
            this.applyFilters();
        },

        clearAllFilters() {
            this.search = '';
            this.laptopFilter = '';
            this.applyFilters();
        },

        performSearch() {
            this.applyFilters();
        },

        applyFilters() {
            const params = new URLSearchParams();
            params.append('page', '1'); // Reset to first page

            if (this.search) params.append('search', this.search);
            if (this.laptopFilter) params.append('laptop', this.laptopFilter);
            if (this.perPage) params.append('per_page', this.perPage);

            window.location.href = '?' + params.toString();
        },

        async searchApplications() {
            if (!this.search && !this.laptopFilter) return;

            this.loading = true;

            try {
                const response = await this.fetchWithCSRF('{{ url_for("admin.search_applications") }}', {
                    method: 'POST',
                    body: JSON.stringify({
                        search: this.search,
                        laptop: this.laptopFilter,
                        limit: 20
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    // Handle search results if implementing AJAX search
                    console.log('Search results:', data.applications);
                }
            } catch (error) {
                console.error('Search failed:', error);
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endblock %}
